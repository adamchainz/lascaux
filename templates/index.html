<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, width=640, minimum-scale=0.5">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Lascaux - Print high resolution maps from the web</title>

    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.simplex.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/static/css/custom.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="/static/js/html5shiv.js"></script>
      <script src="/static/js/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  </head>

  <body>
    <div class="container">
      <div class='col-md-10 col-md-offset-1'>

        <h1>
          Lascaux
          <small>Print high resolution maps from the web</small>
        </h1>
        <hr />

        <form role="form" class="form-horizontal">
          <div class="form-group">
            <label for="overlay_tiles" class="col-sm-2 control-label">Data source</label>
            <div class="col-sm-10">
              <div class='input-group'>
                <input type="text" class="form-control" id="overlay_tiles" placeholder="http://a.tiles.mapbox.com/v3/datamade.hnmob3j3/{z}/{x}/{y}.png">
                <span class="input-group-btn">
                  <a href='#' id='add_overlay_tiles' class='btn btn-info'><i class='fa fa-plus-circle'></i> Add to preview</a>
                </span>
              </div>
              <p class="help-block">URL to a TileJSON source</p>
            </div>
          </div>
          <div class="form-group">
            <label for="dimensions" class="col-sm-2 control-label">Paper size</label>
            <div class="col-sm-3">
              <select class="form-control" id="dimensions">
                <option value='1275,1650'>Letter 8 1/2" by 11"</option>
                <option value='2550,3300'>Tabloid 11" x 17"</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="center" class="col-sm-2 control-label">Preview</label>
            <div class="col-sm-10">
              <div id="map"></div>
            </div>
          </div>
          <div class="form-group">
            <div class='col-sm-10 col-sm-offset-2'>
              <button id="submit-download" type="submit" class="btn btn-success btn-lg">
                <i class='fa fa-download'></i>
                Download PDF
              </button>
              <span id="download-link"></span>
            </div>
          </div>
        </form>

        <div class="footer">
          <p class='pull-right'>&copy; <a href='http://datamade.us'>DataMade</a> and <a href='http://lisc-chicago.org'>LISC Chicago</a> | <a href='https://github.com/datamade/lascaux'><i class='icon-github'></i> Pull requests welcome!</a></p>
        </div>
      </div>
    </div> <!-- /container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/moment.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="/static/js/analytics_lib.js"></script>

    <script>
      var map;
      var base_tiles = '';
      var overlay_tiles;
      var layers;
      $(function() {

        var mapbox_streets = L.tileLayer('https://{s}.tiles.mapbox.com/v3/datamade.hn83a654/{z}/{x}/{y}.png', {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
          detectRetina: true
        });

        var mapbox_satellite = L.tileLayer('https://{s}.tiles.mapbox.com/v3/datamade.k92mcmc8/{z}/{x}/{y}.png', {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
          detectRetina: true
        });

        var stamen_toner = L.tileLayer('http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.jpg', {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
          detectRetina: true
        });

        var stamen_terrain = L.tileLayer('http://{s}.tile.stamen.com/terrain/{z}/{x}/{y}.jpg', {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
          detectRetina: true
        });

        var open_street_map = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
          detectRetina: true
        });

        // init map
        map = L.map('map', { scrollWheelZoom: false }).setView([41.87467,-87.62627], 12);
        
        var baseMaps = {"Toner by Stamen": stamen_toner, 
                        "Terrain by Stamen": stamen_terrain, 
                        "Streets by Mapbox": mapbox_streets, 
                        "Satellite by Mapbox": mapbox_satellite,
                        "Open Street Map": open_street_map
                      };

        stamen_toner.addTo(map);
        base_tiles = stamen_toner._url;

        layers = L.control.layers(baseMaps, {}, { collapsed: false, autoZIndex: true }).addTo(map);

        // Add in a crosshair for the map
        var crosshairIcon = L.icon({
            iconUrl: '/static/images/crosshair.png',
            iconSize:     [20, 20], // size of the icon
            iconAnchor:   [10, 10], // point of the icon which will correspond to marker's location
        });
        crosshair = new L.marker(map.getCenter(), {icon: crosshairIcon, clickable:false});
        crosshair.addTo(map);

        // Move the crosshair to the center of the map when the user pans
        map.on('move', function(e) {
            crosshair.setLatLng(map.getCenter());
        });

        map.on('baselayerchange', function(e) {
          base_tiles = e.layer._url;
        });

        $("#add_overlay_tiles").on("click", function(e){
          e.preventDefault();
          if (overlay_tiles) {
            overlay_tiles.removeLayer(map);
            layers.removeLayer(overlay_tiles);
          }

          overlay_tiles = L.tileLayer($("#overlay_tiles").val(), { detectRetina: true });
          layers.addOverlay(overlay_tiles, "Data source");
          overlay_tiles.addTo(map);
        });

        // click listener for download PDF button
        $("#submit-download").on("click", function(e){
          e.preventDefault();
          var params = {
            overlay_tiles: $("#overlay_tiles").val(),
            base_tiles: base_tiles,
            dimensions: $("#dimensions").val(),
            zoom: map.getZoom(),
            center: map.getCenter().lng + "," + map.getCenter().lat
          }

          var download_url = "/api?" + $.param(params)
          $("#download-link").html("<a class='btn btn-info btn-lg' href='http://lascaux.datamade.us" + download_url + "'><i class='fa fa-link'></i> Link to this map</a>")
          window.open(download_url)
        });
      });
    </script>

  </body>
</html>
